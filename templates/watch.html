{% extends "base.html" %}

{% block title %}{{ video_info.title }} - れんれんtube{% endblock %}

{% block extra_css %}
<style>
    /* 動画プレイヤーエリア */
    .video-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }

    .video-player {
        width: 100%;
        aspect-ratio: 16 / 9;
    }

    iframe.video-player {
        border: none;
    }

    /* 動画情報エリア */
    .video-info {
        padding: 20px 0;
    }

    .video-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .video-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .video-stats {
        color: #606060;
        font-size: 14px;
    }

    .video-actions {
        display: flex;
        gap: 12px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
    }

    .action-btn:hover {
        background: #f8f8f8;
        border-color: #ccc;
    }

    .action-btn i {
        font-size: 16px;
    }

    /* チャンネル情報 */
    .channel-info {
        display: flex;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .channel-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 12px;
        background: #e0e0e0;
    }

    .channel-details {
        flex: 1;
    }

    .channel-name {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .channel-name a {
        color: #0f0f0f;
        text-decoration: none;
    }

    .channel-name a:hover {
        color: #065fd4;
    }

    /* 説明文 */
    .video-description {
        padding: 16px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .description-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.6;
        max-height: 80px;
        overflow: hidden;
        position: relative;
    }

    .description-text.expanded {
        max-height: none;
    }

    .description-toggle {
        margin-top: 8px;
        background: none;
        border: none;
        color: #065fd4;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
        font-size: 14px;
    }

    .description-toggle:hover {
        text-decoration: underline;
    }

    /* コメントセクション */
    .comments-section {
        padding: 24px 0;
    }

    .comments-header {
        display: flex;
        align-items: center;
        margin-bottom: 24px;
        font-size: 16px;
        font-weight: 600;
    }

    .comment-item {
        display: flex;
        margin-bottom: 20px;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        background: #e0e0e0;
    }

    .comment-content {
        flex: 1;
    }

    .comment-author {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .comment-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
    }

    .comment-meta {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: #606060;
    }

    /* 関連動画 */
    .related-videos-section {
        position: sticky;
        top: 80px;
    }

    .related-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .reload-btn {
        padding: 6px 12px;
        font-size: 13px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .reload-btn:hover {
        background: #f8f8f8;
    }

    .related-video-item {
        display: flex;
        margin-bottom: 12px;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        transition: background 0.2s;
    }

    .related-video-item:hover {
        background: #f8f8f8;
    }

    .related-thumbnail-container {
        position: relative;
        width: 168px;
        flex-shrink: 0;
    }

    .related-thumbnail {
        width: 100%;
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 8px;
    }

    .duration-badge {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 4px;
        border-radius: 2px;
        font-size: 12px;
        font-weight: 500;
    }

    .live-badge {
        background: #cc0000;
    }

    .related-info {
        flex: 1;
        padding: 0 12px;
        min-width: 0;
    }

    .related-title {
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .related-channel {
        font-size: 12px;
        color: #606060;
        margin-bottom: 2px;
    }

    .related-meta {
        font-size: 12px;
        color: #606060;
    }

    /* ローディング */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
        .video-title {
            font-size: 18px;
        }

        .related-videos-section {
            position: static;
            margin-top: 24px;
        }

        .related-thumbnail-container {
            width: 120px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1800px; padding: 24px;">
    <div class="row">
        <!-- 動画プレイヤーとメイン情報 -->
        <div class="col-lg-8 col-md-7">
            <!-- 動画プレイヤー -->
            <div class="video-container">
                {% if stream_data %}
                    <video class="video-player" controls autoplay>
                        {% if stream_data.get('720p') %}
                            <source src="{{ stream_data['720p'] }}" type="video/mp4">
                        {% elif stream_data.get('480p') %}
                            <source src="{{ stream_data['480p'] }}" type="video/mp4">
                        {% elif stream_data.get('360p') %}
                            <source src="{{ stream_data['360p'] }}" type="video/mp4">
                        {% endif %}
                        お使いのブラウザは動画再生に対応していません。
                    </video>
                {% else %}
                    <iframe 
                        class="video-player"
                        src="https://www.youtube-nocookie.com/embed/{{ video_info.videoId }}?autoplay=1&rel=0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                {% endif %}
            </div>

            <!-- 動画情報 -->
            <div class="video-info">
                <h1 class="video-title">{{ video_info.title }}</h1>
                
                <div class="video-meta">
                    <div class="video-stats">
                        {% if video_info.viewCount %}
                            <span>{{ video_info.viewCount|format_view_count_with_suffix }}</span>
                        {% endif %}
                        {% if video_info.publishedText %}
                            <span> • {{ video_info.publishedText|format_published_japanese }}</span>
                        {% endif %}
                    </div>
                    <div class="video-actions">
                        <button class="action-btn" onclick="shareVideo()">
                            <i class="fas fa-share"></i>
                            <span>共有</span>
                        </button>
                    </div>
                </div>

                <!-- チャンネル情報 -->
                <div class="channel-info">
                    <img src="https://yt3.ggpht.com/ytc/default_144.jpg" 
                         alt="{{ video_info.author }}" 
                         class="channel-avatar"
                         onerror="this.src='https://via.placeholder.com/48'">
                    <div class="channel-details">
                        <div class="channel-name">
                            {% if video_info.authorId %}
                                <a href="/channel/{{ video_info.authorId }}">{{ video_info.author }}</a>
                            {% else %}
                                {{ video_info.author }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 説明文 -->
                {% if video_info.description %}
                <div class="video-description">
                    <div class="description-text" id="descriptionText">{{ video_info.description }}</div>
                    <button class="description-toggle" id="descriptionToggle" onclick="toggleDescription()">
                        もっと見る
                    </button>
                </div>
                {% endif %}

                <!-- コメントセクション -->
                <div class="comments-section">
                    <div class="comments-header">
                        <i class="fas fa-comment me-2"></i>
                        <span>コメント</span>
                    </div>
                    <div id="commentsContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>コメントを読み込み中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 関連動画サイドバー -->
        <div class="col-lg-4 col-md-5">
            <div class="related-videos-section">
                <div class="related-header">
                    <span>関連動画</span>
                    <button class="reload-btn" onclick="loadRelatedVideos()">
                        <i class="fas fa-sync"></i>
                        <span>更新</span>
                    </button>
                </div>
                
                <div id="relatedVideosContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm mb-2"></div>
                        <p style="font-size: 14px; color: #606060;">関連動画を読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// グローバル変数
const videoId = '{{ video_info.videoId }}';
const videoTitle = '{{ video_info.title[:30] }}';

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 関連動画を読み込み（100ms後）
    setTimeout(() => {
        loadRelatedVideos();
    }, 100);
    
    // コメントを読み込み（500ms後）
    setTimeout(() => {
        loadComments();
    }, 500);
});

// 関連動画読み込み
function loadRelatedVideos() {
    const container = document.getElementById('relatedVideosContainer');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
    
    const query = encodeURIComponent(videoTitle);
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    fetch(`/api/related-videos/${videoId}?q=${query}`, {
        signal: controller.signal
    })
        .then(response => response.json())
        .then(data => {
            clearTimeout(timeoutId);
            if (data.success && data.videos && data.videos.length > 0) {
                displayRelatedVideos(data.videos);
            } else {
                container.innerHTML = '<div class="text-muted text-center py-3"><small>関連動画が見つかりません</small></div>';
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('関連動画エラー:', error);
            container.innerHTML = '<div class="text-muted text-center py-3"><small>読み込みに失敗しました</small></div>';
        });
}

// 関連動画表示
function displayRelatedVideos(videos) {
    const container = document.getElementById('relatedVideosContainer');
    const fragment = document.createDocumentFragment();
    
    videos.slice(0, 20).forEach(video => {
        const div = document.createElement('div');
        div.className = 'related-video-item';
        div.onclick = () => watchVideo(video.videoId);
        
        const duration = video.lengthSeconds ? formatDurationJapanese(video.lengthSeconds) : '';
        const isLive = video.lengthSeconds === 0 || video.liveNow;
        
        div.innerHTML = `
            <div class="related-thumbnail-container">
                <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" 
                     class="related-thumbnail"
                     alt="${escapeHtml(video.title)}"
                     loading="lazy"
                     onerror="this.src='https://img.youtube.com/vi/${video.videoId}/default.jpg'">
                ${isLive ? '<div class="duration-badge live-badge">ライブ</div>' : 
                  (duration ? `<div class="duration-badge">${duration}</div>` : '')}
            </div>
            <div class="related-info">
                <div class="related-title">${escapeHtml(video.title)}</div>
                <div class="related-channel">${escapeHtml(video.author || '不明')}</div>
                <div class="related-meta">
                    ${video.viewCount ? formatViewCount(video.viewCount) + '回視聴' : ''}
                    ${video.publishedText ? ' • ' + escapeHtml(video.publishedText) : ''}
                </div>
            </div>
        `;
        
        fragment.appendChild(div);
    });
    
    container.innerHTML = '';
    container.appendChild(fragment);
}

// コメント読み込み
function loadComments() {
    const container = document.getElementById('commentsContainer');
    
    fetch(`/api/comments/${videoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.comments && data.comments.length > 0) {
                displayComments(data.comments);
            } else {
                container.innerHTML = '<div class="text-muted text-center py-3"><small>コメントがありません</small></div>';
            }
        })
        .catch(error => {
            console.error('コメントエラー:', error);
            container.innerHTML = '<div class="text-muted text-center py-3"><small>コメントの読み込みに失敗しました</small></div>';
        });
}

// コメント表示
function displayComments(comments) {
    const container = document.getElementById('commentsContainer');
    const fragment = document.createDocumentFragment();
    
    comments.slice(0, 20).forEach(comment => {
        const div = document.createElement('div');
        div.className = 'comment-item';
        
        const avatarUrl = comment.authorThumbnail || 'https://yt3.ggpht.com/ytc/default_48.jpg';
        
        div.innerHTML = `
            <img src="${avatarUrl}" 
                 class="comment-avatar" 
                 alt="${escapeHtml(comment.author || '匿名')}"
                 onerror="this.src='https://via.placeholder.com/40'">
            <div class="comment-content">
                <div class="comment-author">${escapeHtml(comment.author || '匿名')}</div>
                <div class="comment-text">${escapeHtml(comment.content || '')}</div>
                <div class="comment-meta">
                    ${comment.likeCount ? `<span>${comment.likeCount} いいね</span>` : ''}
                    ${comment.publishedText ? `<span>${escapeHtml(comment.publishedText)}</span>` : ''}
                </div>
            </div>
        `;
        
        fragment.appendChild(div);
    });
    
    container.innerHTML = '';
    container.appendChild(fragment);
}

// 説明文の展開/折りたたみ
function toggleDescription() {
    const text = document.getElementById('descriptionText');
    const btn = document.getElementById('descriptionToggle');
    
    if (text.classList.contains('expanded')) {
        text.classList.remove('expanded');
        btn.textContent = 'もっと見る';
    } else {
        text.classList.add('expanded');
        btn.textContent = '折りたたむ';
    }
}

// 動画遷移
function watchVideo(newVideoId) {
    window.location.href = `/watch?v=${newVideoId}`;
}

// 共有機能
function shareVideo() {
    const url = window.location.href;
    
    if (navigator.share) {
        navigator.share({
            title: '{{ video_info.title }}',
            url: url
        }).catch(err => console.log('共有エラー:', err));
    } else {
        // フォールバック: URLをコピー
        navigator.clipboard.writeText(url).then(() => {
            alert('URLをコピーしました');
        }).catch(err => {
            console.error('コピーエラー:', err);
            prompt('URLをコピーしてください:', url);
        });
    }
}

// ヘルパー関数
function formatViewCount(count) {
    if (!count) return '';
    count = parseInt(count);
    if (count >= 100000000) {
        return Math.floor(count / 100000000) + '億';
    } else if (count >= 10000) {
        return Math.floor(count / 10000) + '万';
    } else {
        return count.toLocaleString();
    }
}

function formatDurationJapanese(seconds) {
    if (!seconds) return '';
    seconds = parseInt(seconds);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    
    if (h > 0) {
        return m > 0 ? `${h}時間${m}分` : `${h}時間`;
    } else if (m > 0) {
        return s > 0 ? `${m}分${s}秒` : `${m}分`;
    } else {
        return `${s}秒`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}