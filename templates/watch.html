{% extends "base.html" %}

{% block title %}
{% if video_info %}{{ video_info.title }} - ã‚Œã‚“ã‚Œã‚“tube{% else %}å‹•ç”»ã‚’è¦–è´ - ã‚Œã‚“ã‚Œã‚“tube{% endif %}
{% endblock %}

{% block og_title %}
{% if video_info %}{{ video_info.title }} - ã‚Œã‚“ã‚Œã‚“tube{% else %}å‹•ç”»ã‚’è¦–è´ - ã‚Œã‚“ã‚Œã‚“tube{% endif %}
{% endblock %}

{% block og_description %}
{% if video_info and video_info.description %}{{ (video_info.description[:150] + "...") }}{% else %}ã‚Œã‚“ã‚Œã‚“tubeã§å‹•ç”»è¦–è´{% endif %}
{% endblock %}

{% block og_type %}video{% endblock %}

{% block og_image %}
{% if video_info and video_info.videoId %}https://img.youtube.com/vi/{{ video_info.videoId }}/maxresdefault.jpg{% else %}{{ request.url_root.replace('http://', 'https://').replace(':5000', '.replit.app') }}static/og-image.jpg{% endif %}
{% endblock %}

{% block og_image_alt %}
{% if video_info %}{{ video_info.title }}ã®ã‚µãƒ ãƒã‚¤ãƒ«{% else %}ã‚Œã‚“ã‚Œã‚“tube{% endif %}
{% endblock %}

{% block content %}
{% if video_info and stream_data %}
<div class="watch-page-container" style="max-width: 1280px; margin: 0 auto; padding: 20px;">
    <div class="row">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="col-lg-8 col-md-7">
            <!-- å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="video-player-section mb-3">
                <!-- YouTube Education åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º) -->
                <div id="youtubeEduPlayer">
                    <div class="embed-container" style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; background: #000; border-radius: 8px; overflow: hidden;">
                        {% if stream_data.youtube_education_url %}
                        <iframe id="youtubeEduFrame" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                                src="{{ stream_data.youtube_education_url }}"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-white">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            åŸ‹ã‚è¾¼ã¿å‹•ç”»ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“
                        </div>
                        {% endif %}
                    </div>
                    <div class="player-mode-info mt-2 p-2 bg-success bg-opacity-10 rounded">
                        <small class="text-success">
                            <i class="fas fa-graduation-cap me-1"></i>
                            YouTube Educationã§å†ç”Ÿä¸­
                        </small>
                        <button class="btn btn-outline-primary btn-sm me-2 float-end" onclick="toggleToStreamPlayer()">
                            <i class="fas fa-play"></i> ã‚¹ãƒˆãƒªãƒ¼ãƒ å†ç”Ÿã«åˆ‡ã‚Šæ›¿ãˆ
                        </button>
                    </div>
                </div>

                <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ (éè¡¨ç¤º) -->
                <div id="streamPlayer" style="display: none;">
                    {% if stream_data.best_url or (stream_data.formats and stream_data.formats|length > 0) %}
                    <div class="custom-video-player">
                        <video id="videoPlayer" class="w-100" preload="metadata" 
                               playsinline webkit-playsinline
                               style="width: 100%; height: auto; aspect-ratio: 16/9; background: #000; border-radius: 8px;"
                               {% if not (stream_data.formats and stream_data.formats[0].has_audio) %}muted{% endif %}>
                            {% if stream_data.best_url %}
                            <source src="{{ stream_data.best_url }}" 
                                    type="{% if stream_data.formats and stream_data.formats[0].container == 'webm' %}video/webm{% else %}video/mp4{% endif %}">
                            {% endif %}
                            <p>ã“ã®ãƒ“ãƒ‡ã‚ªã‚’å†ç”Ÿã™ã‚‹ã«ã¯ã€HTML5å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™ã€‚</p>
                        </video>
                        
                        <!-- YouTubeé¢¨ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                        <div class="custom-controls" id="customControls">
                            <div class="progress-container">
                                <div class="progress-bar" id="progressBar">
                                    <div class="progress-filled" id="progressFilled"></div>
                                    <div class="progress-handle" id="progressHandle"></div>
                                </div>
                            </div>
                            
                            <div class="controls-bottom">
                                <div class="controls-left">
                                    <button class="control-btn" id="playPauseBtn">
                                        <i class="fas fa-play" id="playPauseIcon"></i>
                                    </button>
                                    <button class="control-btn" id="muteBtn">
                                        <i class="fas fa-volume-up" id="muteIcon"></i>
                                    </button>
                                    <div class="volume-container">
                                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                                    </div>
                                    <span class="time-display">
                                        <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                                    </span>
                                </div>
                                
                                <div class="controls-right">
                                    <!-- ç”»è³ªé¸æŠï¼ˆå¤šå“è³ªãƒ»éŸ³å£°åˆ†é›¢å¯¾å¿œï¼‰ -->
                                    {% if stream_data %}
                                    <select class="form-select form-select-sm me-2" id="qualitySelect" style="width: auto; display: inline-block;">
                                        {% if stream_data.best_url %}
                                        <option value="{{ stream_data.best_url }}" 
                                                data-quality="auto"
                                                data-audio-url=""
                                                data-has-audio="{% if stream_data.has_audio %}true{% else %}false{% endif %}">
                                            è‡ªå‹•
                                        </option>
                                        {% endif %}
                                        
                                        {% if stream_data.multi_quality and stream_data.quality_streams %}
                                        <!-- æ–°ã—ã„å¤šå“è³ªå½¢å¼ -->
                                        {% for quality, streams in stream_data.quality_streams.items() %}
                                        {% if streams.video_url or streams.combined_url %}
                                        <option value="{{ streams.combined_url or streams.video_url }}" 
                                                data-quality="{{ quality }}"
                                                data-video-url="{{ streams.video_url or '' }}"
                                                data-audio-url="{{ streams.audio_url or '' }}"
                                                data-combined-url="{{ streams.combined_url or '' }}"
                                                data-has-audio="{{ streams.has_audio|lower }}"
                                                data-multi-quality="true">
                                            {{ quality }}{% if not streams.has_audio %} (æ˜ åƒã®ã¿){% endif %}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                        {% elif stream_data.formats %}
                                        <!-- å¾“æ¥ã®å½¢å¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰ -->
                                        {% for format in stream_data.formats %}
                                        <option value="{{ format.url }}" 
                                                data-quality="{{ format.quality }}"
                                                data-audio-url="{{ format.audio_url or '' }}"
                                                data-has-audio="{{ format.has_audio|lower }}">
                                            {{ format.quality }}
                                        </option>
                                        {% endfor %}
                                        {% endif %}
                                    </select>
                                    {% endif %}
                                    <button class="control-btn" id="fullscreenBtn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h5>å‹•ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h5>
                        <p>å‹•ç”»ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚YouTube Educationã§å†ç”Ÿã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    {% endif %}
                    
                    <div class="player-mode-info mt-2 p-2 bg-info bg-opacity-10 rounded">
                        <small class="text-primary">
                            <i class="fas fa-play me-1"></i>
                            ã‚¹ãƒˆãƒªãƒ¼ãƒ å†ç”Ÿä¸­
                        </small>
                        <button class="btn btn-outline-success btn-sm me-2 float-end" onclick="toggleToEduPlayer()">
                            <i class="fas fa-graduation-cap"></i> YouTube Educationã«åˆ‡ã‚Šæ›¿ãˆ
                        </button>
                    </div>
                </div>

                <!-- éŸ³å£°å°‚ç”¨ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <audio id="audioPlayer" style="display: none;" preload="metadata"></audio>
            </div>

            <!-- å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ« -->
            <h1 class="video-title mb-2" style="font-size: 1.5rem; font-weight: 600; line-height: 1.4; color: #0f0f0f;">
                {{ video_info.title }}
            </h1>

            <!-- å‹•ç”»æŠ•ç¨¿è€…æƒ…å ±ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ -->
            <div class="author-info d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                <div class="author-avatar me-3" style="cursor: pointer;" onclick="goToChannel()">
                    <img id="authorAvatar" src="https://via.placeholder.com/48x48/cccccc/ffffff?text=ğŸ“º" 
                         alt="æŠ•ç¨¿è€…ã‚¢ã‚¤ã‚³ãƒ³" class="rounded-circle" width="48" height="48"
                         style="border: 2px solid #e5e5e5;">
                </div>
                <div class="author-details flex-grow-1" style="cursor: pointer;" onclick="goToChannel()">
                    <div class="author-name fw-semibold mb-1" id="authorName">
                        {{ video_info.author or 'æŠ•ç¨¿è€…æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...' }}
                    </div>
                    <div class="author-stats text-muted small" id="authorStats">
                        <!-- ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±è¡¨ç¤ºã¯å‰Šé™¤æ¸ˆã¿ -->
                    </div>
                </div>
                <div class="author-actions">
                    <button class="btn btn-outline-primary btn-sm" id="subscribeBtn" style="display: none;">
                        <i class="fas fa-bell me-1"></i> ç™»éŒ²
                    </button>
                </div>
            </div>

            <!-- å‹•ç”»çµ±è¨ˆæƒ…å ± -->
            <div class="video-stats mb-3 d-flex flex-wrap align-items-center" style="color: #606060; font-size: 14px;">
                <span class="me-3">
                    <i class="fas fa-eye me-1"></i>
                    {{ video_info.viewCount|format_view_count_with_suffix }}
                </span>
                {% if video_info.publishedText %}
                <span class="me-3">
                    <i class="fas fa-calendar me-1"></i>
                    {{ video_info.publishedText|format_published_japanese }}
                </span>
                {% endif %}
                <div class="ms-auto">
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="shareVideo()">
                        <i class="fas fa-share me-1"></i> å…±æœ‰
                    </button>
                </div>
            </div>


            <!-- å‹•ç”»èª¬æ˜æ¬„ -->
            {% if video_info.description %}
            <div class="video-description mb-4">
                <div class="description-container p-3" style="background: #f9f9f9; border-radius: 8px; border: 1px solid #e5e5e5;">
                    <div class="description-content" id="descriptionContent">
                        <div class="description-preview">
                            {{ (video_info.description[:300])|replace('\n', '<br>')|safe }}
                            {% if video_info.description|length > 300 %}...{% endif %}
                        </div>
                        {% if video_info.description|length > 300 %}
                        <div class="description-full" style="display: none;">
                            {{ video_info.description|replace('\n', '<br>')|safe }}
                        </div>
                        <button class="btn btn-link btn-sm p-0 mt-2" id="toggleDescription">
                            ã‚‚ã£ã¨è¦‹ã‚‹
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="comments-section">
                <div class="comments-header mb-3">
                    <h6 style="font-weight: 600;">
                        <i class="fas fa-comments me-2"></i>
                        ã‚³ãƒ¡ãƒ³ãƒˆ
                        <span id="commentCount" class="text-muted" style="font-weight: normal;"></span>
                    </h6>
                    <button id="loadCommentsBtn" class="btn btn-outline-primary btn-sm" onclick="loadComments()" style="display: none;">
                        <i class="fas fa-sync me-1"></i> å†èª­ã¿è¾¼ã¿
                    </button>
                </div>
                
                
                <div id="commentsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                        <p class="mt-2">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é–¢é€£å‹•ç”»ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="col-lg-4 col-md-5">
            <div class="related-videos-section">
                <div class="related-header mb-3 d-flex justify-content-between align-items-center">
                    <h6 style="font-weight: 600; margin: 0;">é–¢é€£å‹•ç”»</h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadRelatedVideos()">
                        <i class="fas fa-sync me-1"></i> èª­ã¿è¾¼ã¿
                    </button>
                </div>
                
                <div id="relatedVideosContainer">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-video fa-2x mb-2"></i>
                        <p>é–¢é€£å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <div class="error-state">
        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
        <h4>å‹•ç”»ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“</h4>
        <p class="text-muted mb-4">
            {% if error %}
            {{ error }}
            {% else %}
            ã“ã®å‹•ç”»ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
            {% endif %}
        </p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="fas fa-home me-2"></i>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Toast Notification Container -->
<div class="toast-container position-fixed bottom-0 start-0 p-3" style="z-index: 9999;">
    <div id="likeToast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body d-flex align-items-center">
            <i class="fas fa-thumbs-up me-2"></i>
            <span id="toastMessage">æ“ä½œãŒå®Œäº†ã—ã¾ã—ãŸï¼</span>
        </div>
    </div>
</div>

<style>
/* YouTubeé¢¨ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.custom-video-player {
    position: relative;
    width: 100%;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}

.custom-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.custom-video-player:hover .custom-controls {
    opacity: 1;
}

.progress-container {
    margin-bottom: 8px;
    height: 4px;
    cursor: pointer;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    position: relative;
}

.progress-filled {
    height: 100%;
    background: #ff0000;
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s ease;
}

.progress-handle {
    position: absolute;
    top: -4px;
    width: 12px;
    height: 12px;
    background: #ff0000;
    border-radius: 50%;
    transform: translateX(-50%);
    display: none;
}

.progress-container:hover .progress-handle {
    display: block;
}

.controls-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.controls-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.controls-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-btn {
    background: none;
    border: none;
    color: white;
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s ease;
}

.control-btn:hover {
    background: rgba(255,255,255,0.1);
}

.volume-container {
    display: flex;
    align-items: center;
    width: 60px;
}

.volume-slider {
    width: 100%;
    height: 3px;
    background: rgba(255,255,255,0.3);
    outline: none;
    border-radius: 3px;
}

.time-display {
    color: white;
    font-size: 12px;
    white-space: nowrap;
    margin-left: 8px;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-item {
    padding: 16px 0;
    border-bottom: 1px solid #e5e5e5;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    object-fit: cover;
}

.comment-author {
    font-weight: 600;
    color: #0f0f0f;
    font-size: 13px;
}

.comment-content {
    margin: 4px 0 8px 0;
    line-height: 1.4;
    color: #0f0f0f;
    font-size: 14px;
}

.comment-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.comment-actions .btn {
    color: #606060;
    font-size: 12px;
    padding: 4px 0;
}

.comment-actions .btn:hover {
    color: #0f0f0f;
}

.comment-form .card {
    border: 1px solid #e5e5e5;
    box-shadow: none;
}

.comment-form .card-body {
    padding: 16px;
}

.comment-form textarea {
    border: 1px solid #ccc;
    resize: vertical;
    min-height: 80px;
}

.comment-form textarea:focus {
    border-color: #065fd4;
    box-shadow: 0 0 0 0.2rem rgba(6, 95, 212, 0.25);
}

.comments-list {
    max-height: 600px;
    overflow-y: auto;
}

.comments-list::-webkit-scrollbar {
    width: 8px;
}

.comments-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.comments-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.comments-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* é–¢é€£å‹•ç”»ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.related-video-item {
    display: flex;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.related-video-item:hover {
    background-color: #f8f9fa;
}

.related-thumbnail-container {
    position: relative;
    width: 168px;
    height: 94px;
    flex-shrink: 0;
}

.related-thumbnail {
    width: 100%;
    height: 100%;
    border-radius: 4px;
    object-fit: cover;
}

.duration-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 11px;
    font-weight: 500;
    line-height: 1;
}

.live-badge {
    background: #ff0000 !important;
    color: white;
    font-weight: 600;
}

.related-info {
    flex: 1;
    padding-left: 12px;
}

.related-title {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.4;
    margin-bottom: 4px;
    color: #0f0f0f;
    text-decoration: none;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.related-channel {
    font-size: 12px;
    color: #606060;
    margin-bottom: 2px;
}

.related-meta {
    font-size: 12px;
    color: #606060;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-item {
    padding: 12px 0;
    border-bottom: 1px solid #e5e5e5;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    object-fit: cover;
}

.comment-header {
    display: flex;
    align-items-center;
    margin-bottom: 4px;
}

.comment-author {
    font-weight: 600;
    font-size: 13px;
    color: #0f0f0f;
    margin-right: 8px;
}

.comment-time {
    font-size: 12px;
    color: #606060;
}

.comment-content {
    font-size: 14px;
    line-height: 1.4;
    color: #0f0f0f;
    margin-bottom: 8px;
}

.comment-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.comment-action {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #606060;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .watch-page-container {
        padding: 10px;
    }
    
    .related-videos-section {
        margin-top: 20px;
    }
    
    .related-video-item {
        flex-direction: column;
    }
    
    .related-thumbnail {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
    }
    
    .related-info {
        padding-left: 0;
        padding-top: 8px;
    }
}
</style>

<script>
// ç¾åœ¨ã®å†ç”Ÿãƒ¢ãƒ¼ãƒ‰
let currentPlayerMode = 'education'; // 'education' ã¾ãŸã¯ 'stream'

// ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function toggleToStreamPlayer() {
    document.getElementById('youtubeEduPlayer').style.display = 'none';
    document.getElementById('streamPlayer').style.display = 'block';
    currentPlayerMode = 'stream';
    
    // ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–
    initializeVideoPlayer();
    
    // VKRDownloader APIã®ãƒ‡ãƒ¼ã‚¿ã‚‚çµ±åˆ
    enhanceStreamPlayerWithVKR();
}

function toggleToEduPlayer() {
    document.getElementById('streamPlayer').style.display = 'none';
    document.getElementById('youtubeEduPlayer').style.display = 'block';
    currentPlayerMode = 'education';
}

// æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã¦VKRDownloader APIã®ãƒ‡ãƒ¼ã‚¿ã‚‚ä½¿ç”¨
function enhanceStreamPlayerWithVKR() {
    const videoId = '{{ video_info.videoId }}';
    const audioPlayer = document.getElementById('audioPlayer');
    
    console.log('ğŸš€ VKRDownloader APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—é–‹å§‹:', videoId);
    
    // VKR APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ æ©Ÿèƒ½ã«è¿½åŠ 
    fetch(`/api/vkr-stream/${videoId}`)
        .then(response => {
            console.log('ğŸ“¡ VKR API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ğŸš€ VKRDownloader API ãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.success) {
                console.log('âœ… VKR APIæˆåŠŸ - ãƒ‡ãƒ¼ã‚¿çµ±åˆé–‹å§‹');
                console.log('Video stream:', data.video_stream);
                console.log('Audio stream:', data.audio_stream);
                console.log('Combined stream:', data.combined_stream);
                
                // VKRã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ—¢å­˜ã®ç”»è³ªé¸æŠã«æœ€å„ªå…ˆã§è¿½åŠ 
                addVKRStreamsToQualitySelect(data);
                
                // å‹•ç”»ãƒ»éŸ³å£°åŒæœŸæ©Ÿèƒ½ã‚’è¿½åŠ 
                setupAudioSync(data);
                
                // éŸ³å£°ã‚’å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–
                ensureAudioEnabled();
            } else {
                console.warn('âŒ VKR APIå¤±æ•—:', data.error);
                console.log('æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        })
        .catch(error => {
            console.error('âŒ VKRDownloader API ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰:', error);
            console.log('ğŸ”„ æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ æ©Ÿèƒ½ã‚’æœ€é«˜å“è³ªã«æœ€é©åŒ–ã—ã¾ã™');
            optimizeExistingStreams();
        });
}

// éŸ³å£°ã‚’å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function ensureAudioEnabled() {
    const videoPlayer = document.getElementById('videoPlayer');
    if (videoPlayer) {
        // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
        videoPlayer.muted = false;
        // éŸ³é‡è¨­å®š
        videoPlayer.volume = 0.7;
        
        console.log('ğŸ”Š ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼éŸ³å£°å¼·åˆ¶æœ‰åŠ¹åŒ– - ãƒŸãƒ¥ãƒ¼ãƒˆ:', videoPlayer.muted, 'ãƒœãƒªãƒ¥ãƒ¼ãƒ :', videoPlayer.volume);
        
        // éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚åŒæœŸ
        const volumeSlider = document.getElementById('volumeSlider');
        if (volumeSlider) {
            volumeSlider.value = 70;
        }
        
        // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
        const muteIcon = document.getElementById('muteIcon');
        if (muteIcon) {
            muteIcon.className = 'fas fa-volume-up';
        }
    }
}

function addVKRStreamsToQualitySelect(vkrData) {
    const qualitySelect = document.getElementById('qualitySelect');
    if (!qualitySelect || !vkrData) return;
    
    let vkrOptionsAdded = false;
    let firstOption = null;
    
    // VKRã®åˆ†é›¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆå‹•ç”»+éŸ³å£°ï¼‰ã‚’æœ€å„ªå…ˆã§æœ€åˆã«æŒ¿å…¥
    if (vkrData.video_stream && vkrData.audio_stream && vkrData.video_stream.url && vkrData.audio_stream.url) {
        const option = document.createElement('option');
        option.value = vkrData.video_stream.url;
        option.setAttribute('data-audio-url', vkrData.audio_stream.url);
        option.setAttribute('data-quality', vkrData.video_stream.quality || 'VKRé«˜ç”»è³ª');
        option.setAttribute('data-has-audio', 'separate');
        option.textContent = `ğŸš€ VKRé«˜ç”»è³ª (${vkrData.video_stream.quality || 'HD'}p + Audio)`;
        firstOption = option;
        qualitySelect.insertBefore(option, qualitySelect.firstChild);
        vkrOptionsAdded = true;
        console.log('âœ¨ VKRåˆ†é›¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æœ€å„ªå…ˆã§è¿½åŠ :', vkrData.video_stream.quality || 'HD');
    }
    
    // ğŸ¯ VKRã®å…¨ã¦ã®çµ„ã¿åˆã‚ã›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿½åŠ 
    if (vkrData.all_streams && vkrData.all_streams.combined_streams) {
        const combinedStreams = vkrData.all_streams.combined_streams;
        console.log(`ğŸ¯ VKRå…¨ç”»è³ªè¿½åŠ é–‹å§‹: ${combinedStreams.length}å€‹ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ `);
        
        // ç”»è³ªé †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ç”»è³ªé †ï¼‰
        const sortedStreams = combinedStreams.sort((a, b) => (b.quality || 0) - (a.quality || 0));
        
        // å„ç”»è³ªã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        sortedStreams.forEach((stream, index) => {
            if (stream.url && stream.quality > 0) {
                const option = document.createElement('option');
                option.value = stream.url;
                option.setAttribute('data-quality', stream.quality.toString());
                option.setAttribute('data-has-audio', 'true');
                option.textContent = `ğŸš€ VKR${stream.quality}p (${stream.format || 'mp4'})`;
                
                // æœ€åˆã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠã¨ã—ã¦è¨­å®š
                if (!firstOption && index === 0) {
                    firstOption = option;
                }
                
                qualitySelect.insertBefore(option, qualitySelect.firstChild);
                console.log(`âœ¨ VKRç”»è³ªè¿½åŠ : ${stream.quality}p (${stream.format})`);
            }
        });
        
        vkrOptionsAdded = true;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå˜ä¸€ã®çµ„ã¿åˆã‚ã›ã‚¹ãƒˆãƒªãƒ¼ãƒ 
    else if (vkrData.combined_stream && vkrData.combined_stream.url) {
        const option = document.createElement('option');
        option.value = vkrData.combined_stream.url;
        option.setAttribute('data-quality', vkrData.combined_stream.quality || 'VKR');
        option.setAttribute('data-has-audio', 'true');
        option.textContent = `ğŸš€ VKRçµ„ã¿åˆã‚ã› (${vkrData.combined_stream.quality || 'auto'}p)`;
        
        if (!firstOption) {
            firstOption = option;
        }
        qualitySelect.insertBefore(option, qualitySelect.firstChild);
        vkrOptionsAdded = true;
        console.log('âœ¨ VKRçµ„ã¿åˆã‚ã›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿½åŠ :', vkrData.combined_stream.quality || 'auto');
    }
    
    if (vkrOptionsAdded) {
        // æœ€é«˜ç”»è³ªã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
        if (firstOption) {
            firstOption.selected = true;
        }
        
        console.log('ğŸ¯ VKRã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæœ€å„ªå…ˆã§è¨­å®šã•ã‚Œã¾ã—ãŸ');
        
        // VKRã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒé¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã§ç”»è³ªå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
        const event = new Event('change');
        qualitySelect.dispatchEvent(event);
    }
}

function setupAudioSync(vkrData) {
    const videoPlayer = document.getElementById('videoPlayer');
    const audioPlayer = document.getElementById('audioPlayer');
    const qualitySelect = document.getElementById('qualitySelect');
    
    if (!videoPlayer || !audioPlayer || !qualitySelect) return;
    
    // ç”»è³ªå¤‰æ›´æ™‚ã®å‡¦ç†ã‚’æ‹¡å¼µ
    qualitySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const audioUrl = selectedOption.getAttribute('data-audio-url');
        const hasAudio = selectedOption.getAttribute('data-has-audio');
        
        if (hasAudio === 'separate' && audioUrl) {
            // åˆ†é›¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å ´åˆ
            audioPlayer.src = audioUrl;
            videoPlayer.muted = true; // å‹•ç”»ã®éŸ³å£°ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ
            
            // åŒæœŸå†ç”Ÿè¨­å®š
            setupVideoAudioSync(videoPlayer, audioPlayer);
            
            console.log('ğŸµ VKRåˆ†é›¢ã‚¹ãƒˆãƒªãƒ¼ãƒ å†ç”Ÿè¨­å®šå®Œäº†');
        } else if (hasAudio === 'false' || !hasAudio || audioUrl === '') {
            // æ˜ åƒã®ã¿ã®å ´åˆ - omada APIã‹ã‚‰éŸ³å£°ã‚’è‡ªå‹•å–å¾—
            console.log('ğŸµ æ˜ åƒã®ã¿ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¤œå‡º - omada APIã‹ã‚‰éŸ³å£°å–å¾—ã‚’é–‹å§‹');
            fetchAudioFromOmadaAPI();
        } else {
            // é€šå¸¸ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å ´åˆ
            audioPlayer.src = '';
            videoPlayer.muted = false;
        }
    });
}

function setupVideoAudioSync(videoPlayer, audioPlayer) {
    // åŒæœŸåˆ¶å¾¡
    function syncAudio() {
        if (audioPlayer.src) {
            const timeDiff = Math.abs(videoPlayer.currentTime - audioPlayer.currentTime);
            if (timeDiff > 0.2) { // 0.2ç§’ä»¥ä¸Šã®ã‚ºãƒ¬ã§åŒæœŸ
                audioPlayer.currentTime = videoPlayer.currentTime;
            }
        }
    }
    
    // å‹•ç”»ã®å†ç”Ÿ/ä¸€æ™‚åœæ­¢ã«éŸ³å£°ã‚’åŒæœŸ
    videoPlayer.addEventListener('play', () => {
        if (audioPlayer.src) {
            audioPlayer.currentTime = videoPlayer.currentTime;
            audioPlayer.play().catch(e => console.warn('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
        }
    });
    
    videoPlayer.addEventListener('pause', () => {
        if (audioPlayer.src) {
            audioPlayer.pause();
        }
    });
    
    videoPlayer.addEventListener('seeked', () => {
        if (audioPlayer.src) {
            audioPlayer.currentTime = videoPlayer.currentTime;
            if (!videoPlayer.paused) {
                audioPlayer.play().catch(e => console.warn('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
            }
        }
    });
    
    // å®šæœŸçš„ãªåŒæœŸãƒã‚§ãƒƒã‚¯
    const syncInterval = setInterval(syncAudio, 1000);
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    videoPlayer.addEventListener('ended', () => {
        clearInterval(syncInterval);
    });
}

// omada APIã‹ã‚‰éŸ³å£°ã®ã¿ã‚’å–å¾—ã—ã¦åŒæœŸå†ç”Ÿ
async function fetchAudioFromOmadaAPI() {
    const videoId = '{{ video_info.videoId if video_info else "" }}';
    if (!videoId) {
        console.warn('å‹•ç”»IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const videoPlayer = document.getElementById('videoPlayer');
    const audioPlayer = document.getElementById('audioPlayer');
    
    if (!videoPlayer || !audioPlayer) {
        console.warn('ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    try {
        console.log('ğŸµ omada APIã‹ã‚‰éŸ³å£°å–å¾—é–‹å§‹:', videoId);
        
        // omada APIã‹ã‚‰éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—
        const response = await fetch(`/api/omada-audio/${videoId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`omada API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }
        
        const audioData = await response.json();
        
        if (audioData.success && audioData.audio_url) {
            console.log('âœ… omada APIã‹ã‚‰éŸ³å£°URLå–å¾—æˆåŠŸ:', audioData.audio_url);
            
            // éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã«URLã‚’è¨­å®š
            audioPlayer.src = audioData.audio_url;
            
            // å‹•ç”»ã®éŸ³å£°ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ
            videoPlayer.muted = true;
            
            // éŸ³å£°ã®éŸ³é‡ã‚’è¨­å®š
            audioPlayer.volume = 0.7;
            
            // åŒæœŸå†ç”Ÿè¨­å®š
            setupVideoAudioSync(videoPlayer, audioPlayer);
            
            // ç¾åœ¨å‹•ç”»ãŒå†ç”Ÿä¸­ãªã‚‰éŸ³å£°ã‚‚é–‹å§‹
            if (!videoPlayer.paused) {
                audioPlayer.currentTime = videoPlayer.currentTime;
                audioPlayer.play().catch(e => console.warn('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
            }
            
            console.log('ğŸµ omadaéŸ³å£°åŒæœŸè¨­å®šå®Œäº† - éŸ³é‡:', audioPlayer.volume);
            
            // æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º
            showAudioSyncNotification();
            
        } else {
            console.warn('omada APIã‹ã‚‰éŸ³å£°URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:', audioData);
        }
        
    } catch (error) {
        console.error('omada APIéŸ³å£°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å‹•ç”»ã®éŸ³å£°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        videoPlayer.muted = false;
    }
}

// éŸ³å£°åŒæœŸæˆåŠŸã®é€šçŸ¥è¡¨ç¤º
function showAudioSyncNotification() {
    // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
    const existingNotice = document.getElementById('audio-sync-notice');
    if (existingNotice) {
        existingNotice.remove();
    }
    
    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const notice = document.createElement('div');
    notice.id = 'audio-sync-notice';
    notice.className = 'alert alert-success alert-dismissible fade show mt-2';
    notice.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-volume-up me-2"></i>
            <div>
                <strong>éŸ³å£°åŒæœŸå®Œäº†</strong><br>
                æ˜ åƒã®ã¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«omadaéŸ³å£°ã‚’è‡ªå‹•è¿½åŠ ã—ã¾ã—ãŸ
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ä¸‹ã«æŒ¿å…¥
    const playerSection = document.querySelector('.video-player-section');
    if (playerSection) {
        playerSection.appendChild(notice);
        
        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            if (notice && notice.parentNode) {
                notice.classList.remove('show');
                setTimeout(() => {
                    if (notice && notice.parentNode) {
                        notice.remove();
                    }
                }, 300);
            }
        }, 5000);
    }
}

// VKR APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ æœ€é©åŒ–
function optimizeExistingStreams() {
    const qualitySelect = document.getElementById('qualitySelect');
    if (!qualitySelect) return;
    
    console.log('ğŸš€ æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ å“è³ªã‚’æœ€é©åŒ–ä¸­...');
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å“è³ªé †ã«ã‚½ãƒ¼ãƒˆ
    const options = Array.from(qualitySelect.options);
    const sortedOptions = options.sort((a, b) => {
        const aQuality = parseInt(a.getAttribute('data-quality') || '0') || 0;
        const bQuality = parseInt(b.getAttribute('data-quality') || '0') || 0;
        return bQuality - aQuality; // é™é †ï¼ˆé«˜å“è³ªå„ªå…ˆï¼‰
    });
    
    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰
    qualitySelect.innerHTML = '';
    
    // æœ€é«˜å“è³ªã‹ã‚‰é †ã«è¿½åŠ 
    sortedOptions.forEach((option, index) => {
        const quality = option.getAttribute('data-quality') || 'unknown';
        const hasAudio = option.getAttribute('data-has-audio') || 'false';
        
        // æœ€é«˜å“è³ªã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆè¡¨ç¤º
        if (index === 0) {
            option.textContent = `ğŸ† æœ€é«˜å“è³ª (${quality})`;
            option.selected = true;
        } else {
            option.textContent = `${quality}${hasAudio === 'true' ? ' (éŸ³å£°ä»˜ã)' : ''}`;
        }
        
        qualitySelect.appendChild(option);
    });
    
    // æœ€é«˜å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒé¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã§ç”»è³ªå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    if (qualitySelect.options.length > 0) {
        const event = new Event('change');
        qualitySelect.dispatchEvent(event);
        console.log('âœ… æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæœ€é«˜å“è³ªã§æœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çŠ¶æ³ã‚’é€šçŸ¥
    showOptimizationNotice();
}

// æœ€é©åŒ–é€šçŸ¥ã®è¡¨ç¤º
function showOptimizationNotice() {
    // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
    const existingNotice = document.getElementById('optimization-notice');
    if (existingNotice) {
        existingNotice.remove();
    }
    
    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const notice = document.createElement('div');
    notice.id = 'optimization-notice';
    notice.className = 'alert alert-info alert-dismissible fade show mt-2';
    notice.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>ã‚¹ãƒˆãƒªãƒ¼ãƒ æœ€é©åŒ–å®Œäº†</strong><br>
                æœ€é«˜å“è³ªã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è‡ªå‹•é¸æŠã—ã¾ã—ãŸ
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ä¸‹ã«æŒ¿å…¥
    const playerSection = document.querySelector('.video-player-section');
    if (playerSection) {
        playerSection.appendChild(notice);
        
        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            if (notice && notice.parentNode) {
                notice.classList.remove('show');
                setTimeout(() => {
                    if (notice && notice.parentNode) {
                        notice.remove();
                    }
                }, 300);
            }
        }, 5000);
    }
}

// é–¢é€£å‹•ç”»ã‚’èª­ã¿è¾¼ã¿
function loadRelatedVideos() {
    const container = document.getElementById('relatedVideosContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>é–¢é€£å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    const videoId = '{{ video_info.videoId }}';
    const query = encodeURIComponent('{{ video_info.title[:30] }}');
    
    fetch(`/api/related-videos/${videoId}?q=${query}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.videos) {
                displayRelatedVideos(data.videos);
            } else {
                container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-circle me-1"></i>é–¢é€£å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            }
        })
        .catch(error => {
            console.error('é–¢é€£å‹•ç”»èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            container.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-triangle me-1"></i>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
        });
}

function displayRelatedVideos(videos) {
    const container = document.getElementById('relatedVideosContainer');
    let html = '';
    
    videos.slice(0, 100).forEach(video => {
        const duration = video.lengthSeconds ? formatDurationJapanese(video.lengthSeconds) : '';
        
        // ãƒ©ã‚¤ãƒ–å‹•ç”»ã®åˆ¤å®š
        const isLive = video.lengthSeconds === 0 || video.liveNow;
        
        html += `
            <div class="related-video-item" onclick="watchVideo('${video.videoId}')" style="cursor: pointer;">
                <div class="related-thumbnail-container">
                    <img src="https://img.youtube.com/vi/${video.videoId}/maxresdefault.jpg" 
                         class="related-thumbnail"
                         alt="${video.title}"
                         onerror="handleThumbnailError(this, '${video.videoId}')"
                         loading="lazy">
                    ${isLive ? 
                        '<div class="duration-badge live-badge">ãƒ©ã‚¤ãƒ–</div>' : 
                        (duration ? `<div class="duration-badge">${duration}</div>` : '')
                    }
                </div>
                <div class="related-info">
                    <div class="related-title">${video.title}</div>
                    <div class="related-channel">${video.author}</div>
                    <div class="related-meta">
                        ${video.viewCount ? formatViewCount(video.viewCount) + 'å›è¦–è´' : ''}
                        ${video.publishedText ? ' â€¢ ' + formatPublishedJapanese(video.publishedText) : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆomada.cafe APIæœ€å„ªå…ˆã€è‡ªå‹•è¡¨ç¤ºå¯¾å¿œï¼‰
function loadComments() {
    const container = document.getElementById('commentsContainer');
    const countSpan = document.getElementById('commentCount');
    
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    const videoId = '{{ video_info.videoId }}';
    let allComments = [];
    let totalCount = 0;
    
    // ğŸ¯ omada.cafe API ã‚’æœ€å„ªå…ˆã§ç›´æ¥ä½¿ç”¨
    fetch(`https://yt.omada.cafe/api/v1/comments/${videoId}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.comments) {
                const rawComments = data.comments || [];
                totalCount = data.commentCount || rawComments.length;
                
                console.log(`âœ… omada.cafe APIã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—æˆåŠŸ: ${totalCount} ä»¶`);
                
                if (rawComments.length > 0) {
                    // omada.cafe APIã®ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–
                    allComments = rawComments.map((comment, index) => {
                        // ã‚¢ãƒã‚¿ãƒ¼URLã‚’å–å¾—
                        let avatarUrl = '';
                        if (comment.authorThumbnails && Array.isArray(comment.authorThumbnails) && comment.authorThumbnails.length > 0) {
                            avatarUrl = comment.authorThumbnails[0].url;
                        } else if (comment.authorThumbnail) {
                            avatarUrl = comment.authorThumbnail;
                        }
                        
                        return {
                            id: comment.id || `omada_${index}`,
                            user: {
                                username: comment.author || 'Unknown User',
                                avatar_url: avatarUrl
                            },
                            content: comment.content || comment.text || '',
                            created_at: comment.publishedText || comment.published || '',
                            likes: comment.likeCount || 0,
                            source: 'omada'
                        };
                    });
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ™‚é–“é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰
                    allComments.sort((a, b) => {
                        const timeA = a.created_at || '';
                        const timeB = b.created_at || '';
                        return timeB.localeCompare(timeA);
                    });
                    
                    displayComments(allComments);
                    countSpan.textContent = `(${totalCount.toLocaleString()} ä»¶)`;
                } else {
                    showNoCommentsMessage();
                }
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å†…éƒ¨APIã‚’ä½¿ç”¨
                loadCommentsFromInternalAPI(videoId);
            }
        })
        .catch(error => {
            console.warn('omada.cafe API ã‚¨ãƒ©ãƒ¼ã€å†…éƒ¨APIã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å†…éƒ¨APIã‚’ä½¿ç”¨
            loadCommentsFromInternalAPI(videoId);
        });
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®å†…éƒ¨APIå‘¼ã³å‡ºã—
function loadCommentsFromInternalAPI(videoId) {
    const container = document.getElementById('commentsContainer');
    const countSpan = document.getElementById('commentCount');
    
    fetch(`/api/priority-comments/${videoId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.comments) {
                const allComments = result.comments || [];
                const totalCount = result.commentCount || allComments.length;
                
                console.log(`âœ… å†…éƒ¨APIã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—æˆåŠŸ: ${totalCount} ä»¶`);
                
                if (allComments.length > 0) {
                    allComments.sort((a, b) => {
                        const timeA = a.created_at || a.publishedText || '';
                        const timeB = b.created_at || b.publishedText || '';
                        return timeB.localeCompare(timeA);
                    });
                    
                    displayComments(allComments);
                    countSpan.textContent = `(${totalCount.toLocaleString()} ä»¶)`;
                } else {
                    showNoCommentsMessage();
                }
            } else {
                showNoCommentsMessage();
            }
        })
        .catch(error => {
            console.error('ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            container.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-triangle me-1"></i>ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
        });
}

// ã‚³ãƒ¡ãƒ³ãƒˆãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
function showNoCommentsMessage() {
    const container = document.getElementById('commentsContainer');
    container.innerHTML = `
        <div class="text-muted text-center py-4">
            <i class="fas fa-comments fa-2x mb-2"></i>
            <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
            <small>æœ€åˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</small>
        </div>
    `;
}

function displayComments(comments, commentCount) {
    const container = document.getElementById('commentsContainer');
    let html = '';
    
    comments.forEach((comment, index) => {
        html += `
            <div class="comment-item">
                <div class="d-flex">
                    <div class="me-3">
                        ${comment.authorThumbnails && comment.authorThumbnails.length > 0 ? 
                            `<img src="${comment.authorThumbnails[0].url}" class="comment-avatar rounded-circle" alt="${comment.author}">` :
                            `<div class="comment-avatar rounded-circle bg-secondary d-flex align-items-center justify-content-center">
                                <i class="fas fa-user text-white"></i>
                            </div>`
                        }
                    </div>
                    <div class="flex-grow-1">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${comment.publishedText || ''}</span>
                        </div>
                        <div class="comment-content">
                            ${comment.content.replace(/\n/g, '<br>')}
                        </div>
                        <div class="comment-actions">
                            ${comment.likeCount > 0 ? 
                                `<div class="comment-action">
                                    <i class="fas fa-thumbs-up me-1"></i>${comment.likeCount}
                                </div>` : ''
                            }
                            ${comment.replies > 0 ? 
                                `<div class="comment-action">
                                    <i class="fas fa-reply me-1"></i>${comment.replies} ä»¶ã®è¿”ä¿¡
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// å‹•ç”»å…±æœ‰æ©Ÿèƒ½
function shareVideo() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: '{{ video_info.title }}',
            text: '{{ video_info.author }}ã®å‹•ç”»ã‚’ãƒã‚§ãƒƒã‚¯ï¼',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            showToast('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        });
    }
}

// å†ç”Ÿå›æ•°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
function formatViewCount(count) {
    if (!count) return '';
    
    if (count >= 100000000) {
        const billions = Math.floor(count / 100000000);
        const millions = Math.floor((count % 100000000) / 10000);
        return millions > 0 ? `${billions}å„„${millions}ä¸‡` : `${billions}å„„`;
    } else if (count >= 10000) {
        const millions = Math.floor(count / 10000);
        const thousands = count % 10000;
        return thousands > 0 ? `${millions}ä¸‡${thousands.toLocaleString()}` : `${millions}ä¸‡`;
    } else {
        return count.toLocaleString();
    }
}

// Toastè¡¨ç¤º
function showToast(message) {
    const toast = document.getElementById('likeToast');
    const messageSpan = document.getElementById('toastMessage');
    messageSpan.textContent = message;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}


// Toastè¡¨ç¤ºæ©Ÿèƒ½ã®æ”¹å–„
function showToast(message, type = 'info') {
    // æ—¢å­˜ã®toastãŒã‚ã‚Œã°å‰Šé™¤
    const existingToast = document.getElementById('customToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toastColors = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    const toastIcons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const toastContainer = document.querySelector('.toast-container') || document.body;
    const toast = document.createElement('div');
    toast.id = 'customToast';
    toast.className = `toast ${toastColors[type]} text-white`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="toast-body d-flex align-items-center">
            <i class="fas ${toastIcons[type]} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // ãƒˆãƒ¼ã‚¹ãƒˆå‰Šé™¤
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// èª¬æ˜æ¬„ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleDescription');
    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            const preview = document.querySelector('.description-preview');
            const full = document.querySelector('.description-full');
            
            if (full.style.display === 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
                this.textContent = 'é–‰ã˜ã‚‹';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                this.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
            }
        });
    }
    
    
    // ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’é©ç”¨
    applyLoopMode();
    
    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³åº§ã«è‡ªå‹•èª­ã¿è¾¼ã¿
    loadComments();
    
    // å‹•ç”»æŠ•ç¨¿è€…ã‚¢ã‚¤ã‚³ãƒ³ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
    setTimeout(() => {
        loadAuthorInfo();
    }, 50); // 0.05ç§’å¾Œã«èª­ã¿è¾¼ã¿é–‹å§‹
    
    // é–¢é€£å‹•ç”»ã‚’é«˜é€Ÿèª­ã¿è¾¼ã¿
    setTimeout(() => {
        loadRelatedVideos();
    }, 100); // 0.1ç§’å¾Œã«èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆé«˜é€ŸåŒ–ï¼‰
});

// ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’é©ç”¨
function applyLoopMode() {
    const loopMode = localStorage.getItem('loopMode') === 'true';
    console.log('ğŸ”„ ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰é©ç”¨é–‹å§‹:', loopMode);
    
    // YouTube Education iframeã«ãƒ«ãƒ¼ãƒ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©ç”¨/å‰Šé™¤
    const eduFrame = document.getElementById('youtubeEduFrame');
    if (eduFrame) {
        const currentSrc = eduFrame.src;
        const videoId = '{{ video_info.videoId }}';
        console.log('ğŸ“º ç¾åœ¨ã®iframe URL:', currentSrc);
        
        if (loopMode) {
            // ãƒ«ãƒ¼ãƒ—ã‚ªãƒ³ï¼šãƒ«ãƒ¼ãƒ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            if (currentSrc && !currentSrc.includes('loop=1')) {
                const separator = currentSrc.includes('?') ? '&' : '?';
                const newSrc = currentSrc + separator + 'loop=1&playlist=' + videoId;
                console.log('âœ… ãƒ«ãƒ¼ãƒ—ã‚ªãƒ³ - æ–°ã—ã„URL:', newSrc);
                eduFrame.src = newSrc;
            } else {
                console.log('â„¹ï¸ ãƒ«ãƒ¼ãƒ—ã¯æ—¢ã«æœ‰åŠ¹ã§ã™');
            }
        } else {
            // ãƒ«ãƒ¼ãƒ—ã‚ªãƒ•ï¼šãƒ«ãƒ¼ãƒ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            if (currentSrc && currentSrc.includes('loop=1')) {
                let newSrc = currentSrc
                    .replace(/[?&]loop=1/g, '')
                    .replace(/[?&]playlist=[^&]*/g, '');
                // ?ãŒæ¶ˆãˆã¦ã—ã¾ã£ãŸå ´åˆã®ä¿®æ­£
                newSrc = newSrc.replace(/&/, '?');
                console.log('âŒ ãƒ«ãƒ¼ãƒ—ã‚ªãƒ• - æ–°ã—ã„URL:', newSrc);
                eduFrame.src = newSrc;
            } else {
                console.log('â„¹ï¸ ãƒ«ãƒ¼ãƒ—ã¯æ—¢ã«ç„¡åŠ¹ã§ã™');
            }
        }
    }
    
    // HTML5 ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã«ãƒ«ãƒ¼ãƒ—å±æ€§ã‚’é©ç”¨/å‰Šé™¤
    const videoPlayer = document.getElementById('videoPlayer');
    if (videoPlayer) {
        videoPlayer.loop = loopMode;
        console.log('ğŸ¥ HTML5ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®loopå±æ€§:', videoPlayer.loop);
    }
}

// æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ï¼ˆYouTubeé¢¨ã®çŸ­ç¸®å½¢å¼ï¼‰
function formatDurationJapanese(seconds) {
    if (!seconds || seconds === 0) return '';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
function formatPublishedJapanese(publishedText) {
    if (!publishedText) return '';
    
    // æ—¢ã«æ—¥æœ¬èªå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
    if (publishedText.includes('å‰')) {
        return publishedText;
    }
    
    // ISOå½¢å¼ã®æ—¥ä»˜ã‚’è§£æï¼ˆä¾‹ï¼š2025-09-07T13:00:58Zï¼‰
    if (publishedText.includes('T') && publishedText.endsWith('Z')) {
        try {
            const publishedDate = new Date(publishedText);
            const now = new Date();
            const diffMs = now - publishedDate;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);
            
            if (diffYears >= 1) {
                return `${diffYears}å¹´å‰`;
            } else if (diffMonths >= 1) {
                return `${diffMonths}ãƒ¶æœˆå‰`;
            } else if (diffDays >= 1) {
                return `${diffDays}æ—¥å‰`;
            } else if (diffHours >= 1) {
                return `${diffHours}æ™‚é–“å‰`;
            } else if (diffMinutes >= 1) {
                return `${diffMinutes}åˆ†å‰`;
            } else {
                return 'ãŸã£ãŸä»Š';
            }
        } catch (e) {
            console.warn('æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼:', publishedText, e);
            return publishedText;
        }
    }
    
    return publishedText;
}

// å‹•ç”»è¦–è´ãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ï¼ˆYouTube Education ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
function watchVideo(videoId) {
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§YouTube Education modeãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œå‡º
    const isUsingEducationMode = isCurrentlyUsingYouTubeEducation();
    
    let url = `/watch?v=${videoId}`;
    
    // YouTube Education ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    if (isUsingEducationMode) {
        url += '&edu=1';
    }
    
    window.location.href = url;
}

// ç¾åœ¨YouTube Education ãƒ¢ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œå‡º
function isCurrentlyUsingYouTubeEducation() {
    // YouTube Education iframeãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const eduIframe = document.getElementById('youtubeEducationPlayer');
    if (eduIframe && eduIframe.style.display !== 'none') {
        return true;
    }
    
    // iframeã®srcã«youtubeeducation.comãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (eduIframe && eduIframe.src && eduIframe.src.includes('youtubeeducation.com')) {
        return true;
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§edu=1ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('edu') === '1') {
        return true;
    }
    
    return false;
}

// ã‚µãƒ ãƒã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼å‡¦ç†
function handleThumbnailError(img, videoId) {
    // maxresdefaultã§ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯hqdefaultã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (img.src.includes('maxresdefault')) {
        img.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    } else if (img.src.includes('hqdefault')) {
        // hqdefaultã§ã‚‚ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯defaultã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        img.src = `https://img.youtube.com/vi/${videoId}/default.jpg`;
    }
}

// ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼åˆæœŸåŒ–
function initializeVideoPlayer() {
    // æ—¢å­˜ã®player.jsã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
    if (typeof VideoPlayer !== 'undefined') {
        new VideoPlayer();
    }
}


// ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
function displayComments(comments) {
    const container = document.getElementById('commentsContainer');
    
    if (!comments || comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                <small>æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</small>
            </div>
        `;
        return;
    }
    
    const commentsHtml = comments.map(comment => {
        // ã‚¢ãƒã‚¿ãƒ¼URLã®æ”¹å–„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®è³ªã‚’å‘ä¸Šï¼‰
        let avatarUrl = comment.user?.avatar_url || '';
        
        if (!avatarUrl || avatarUrl === '') {
            // YouTubeã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã‚’ä½¿ç”¨
            const userInitial = (comment.user?.username || 'U').charAt(0).toUpperCase();
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
            const colorIndex = userInitial.charCodeAt(0) % colors.length;
            const backgroundColor = colors[colorIndex].replace('#', '');
            avatarUrl = `https://via.placeholder.com/48x48/${backgroundColor}/ffffff?text=${userInitial}`;
        }
        const username = comment.user?.username || 'Unknown User';
        const content = comment.content || '';
        const timeAgo = formatTimeAgo(comment.created_at);
        const likes = comment.likes || 0;
        const sourceIcon = comment.source === 'local' ? '<i class="fas fa-home text-primary" title="ãƒ­ãƒ¼ã‚«ãƒ«"></i>' : '<i class="fab fa-youtube text-danger" title="YouTube"></i>';
        
        return `
            <div class="comment-item">
                <div class="d-flex">
                    <img src="${avatarUrl}" alt="${username}" class="comment-avatar rounded-circle me-3" 
                         onerror="this.src='https://via.placeholder.com/40x40/cccccc/ffffff?text=U'">
                    <div class="flex-grow-1">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(username)}</span>
                            <small class="text-muted ms-2">${timeAgo}</small>
                            <small class="ms-2">${sourceIcon}</small>
                        </div>
                        <div class="comment-content">
                            <p class="mb-2">${escapeHtml(content).replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="comment-actions">
                            <button class="btn btn-link btn-sm p-0 me-3" onclick="likeComment(${comment.id})">
                                <i class="fas fa-thumbs-up me-1"></i>
                                <span id="likes_${comment.id}">${likes}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="comments-list">
            ${commentsHtml}
        </div>
    `;
}

// HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// æ™‚é–“ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatTimeAgo(dateString) {
    if (!dateString) return '';
    
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffMonths = Math.floor(diffDays / 30);
        const diffYears = Math.floor(diffDays / 365);
        
        if (diffYears >= 1) {
            return `${diffYears}å¹´å‰`;
        } else if (diffMonths >= 1) {
            return `${diffMonths}ãƒ¶æœˆå‰`;
        } else if (diffDays >= 1) {
            return `${diffDays}æ—¥å‰`;
        } else if (diffHours >= 1) {
            return `${diffHours}æ™‚é–“å‰`;
        } else if (diffMinutes >= 1) {
            return `${diffMinutes}åˆ†å‰`;
        } else {
            return 'ãŸã£ãŸä»Š';
        }
    } catch (e) {
        return dateString;
    }
}

// ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã®æ›´æ–°
function updateCommentCount(count) {
    const commentCount = document.getElementById('commentCount');
    if (commentCount) {
        commentCount.textContent = count > 0 ? `(${count}ä»¶)` : '(0ä»¶)';
    }
}

// ã‚³ãƒ¡ãƒ³ãƒˆã„ã„ã­æ©Ÿèƒ½
async function likeComment(commentId) {
    try {
        const response = await fetch(`/api/comments/${commentId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const likesElement = document.getElementById(`likes_${commentId}`);
            if (likesElement) {
                likesElement.textContent = data.likes;
            }
            showToast('ã„ã„ã­ã—ã¾ã—ãŸï¼');
        }
    } catch (error) {
        console.error('ã„ã„ã­ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
}
</script>

<script>
// å‹•ç”»æŠ•ç¨¿è€…æƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
async function loadAuthorInfo() {
    const videoId = '{{ video_info.videoId if video_info else "" }}';
    if (!videoId) {
        console.error('Video ID not found for author info');
        return;
    }
    
    try {
        console.log('ğŸ­ å‹•ç”»æŠ•ç¨¿è€…æƒ…å ±å–å¾—é–‹å§‹:', videoId);
        
        // è¤‡æ•°ã®APIã‹ã‚‰æŠ•ç¨¿è€…æƒ…å ±ã‚’å–å¾—è©¦è¡Œ
        const apiSources = [
            `/api/video-author/${videoId}`,
            `/api/related-videos/${videoId}?q=author`
        ];
        
        for (const apiUrl of apiSources) {
            try {
                const response = await fetch(apiUrl, {
                    headers: { 'Accept': 'application/json' },
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let authorInfo = null;
                    
                    // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹é€ ã«å¿œã˜ã¦æŠ•ç¨¿è€…æƒ…å ±ã‚’æŠ½å‡º
                    if (data.success && data.author_info) {
                        authorInfo = data.author_info;
                    } else if (data.success && data.videos && data.videos.length > 0) {
                        // é–¢é€£å‹•ç”»APIã‹ã‚‰æŠ•ç¨¿è€…æƒ…å ±ã‚’æŠ½å‡º
                        const firstVideo = data.videos[0];
                        authorInfo = {
                            author: firstVideo.author || '{{ video_info.author }}',
                            authorId: firstVideo.authorId || '{{ video_info.authorId }}',
                            avatar_url: firstVideo.authorThumbnails && firstVideo.authorThumbnails.length > 0 
                                ? firstVideo.authorThumbnails[0].url 
                                : ''
                        };
                    }
                    
                    if (authorInfo && authorInfo.author) {
                        // æŠ•ç¨¿è€…ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                        const authorAvatar = document.getElementById('authorAvatar');
                        if (authorAvatar) {
                            if (authorInfo.avatar_url) {
                                authorAvatar.src = authorInfo.avatar_url;
                                authorAvatar.alt = `${authorInfo.author}ã®ã‚¢ã‚¤ã‚³ãƒ³`;
                                console.log('âœ… æŠ•ç¨¿è€…ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°æˆåŠŸ:', authorInfo.author);
                            } else {
                                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
                                authorAvatar.src = 'https://yt3.ggpht.com/ytc/AOPolaDefault=s88-c-k-c0x00ffffff-no-rj';
                                authorAvatar.alt = `${authorInfo.author}ã®ã‚¢ã‚¤ã‚³ãƒ³`;
                            }
                        }
                        
                        // æŠ•ç¨¿è€…åã‚’æ›´æ–°
                        const authorName = document.getElementById('authorName');
                        if (authorName && authorInfo.author) {
                            authorName.textContent = authorInfo.author;
                        }
                        
                        console.log('âœ… æŠ•ç¨¿è€…æƒ…å ±æ›´æ–°å®Œäº†:', authorInfo.author);
                        return; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    }
                }
            } catch (error) {
                console.warn(`æŠ•ç¨¿è€…æƒ…å ±API ${apiUrl} ã‚¨ãƒ©ãƒ¼:`, error);
                continue; // æ¬¡ã®APIã‚’è©¦è¡Œ
            }
        }
        
        // å…¨ã¦ã®APIãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        console.warn('å…¨ã¦ã®æŠ•ç¨¿è€…æƒ…å ±APIãŒå¤±æ•—ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’ä½¿ç”¨');
        const authorAvatar = document.getElementById('authorAvatar');
        const authorName = document.getElementById('authorName');
        
        if (authorName) {
            authorName.textContent = '{{ video_info.author if video_info else "æŠ•ç¨¿è€…" }}';
        }
        
        if (authorAvatar) {
            // YouTubeãƒãƒ£ãƒ³ãƒãƒ«IDã‹ã‚‰æ¨æ¸¬ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            const channelId = '{{ video_info.authorId if video_info else "" }}';
            if (channelId) {
                authorAvatar.src = `https://yt3.ggpht.com/ytc/${channelId}=s88-c-k-c0x00ffffff-no-rj`;
            } else {
                authorAvatar.src = 'https://yt3.ggpht.com/ytc/AOPolaDefault=s88-c-k-c0x00ffffff-no-rj';
            }
            authorAvatar.alt = '{{ video_info.author if video_info else "æŠ•ç¨¿è€…" }}ã®ã‚¢ã‚¤ã‚³ãƒ³';
        }
        
    } catch (error) {
        console.error('æŠ•ç¨¿è€…æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒãƒ£ãƒ³ãƒãƒ«ãƒšãƒ¼ã‚¸ã¸ã®é·ç§»æ©Ÿèƒ½
function goToChannel() {
    const videoInfo = {{ video_info|tojson }};
    if (videoInfo && videoInfo.authorId && videoInfo.author) {
        const channelUrl = `/channel/${videoInfo.authorId}`;
        window.location.href = channelUrl;
    } else {
        console.warn('ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    }
}

</script>

<!-- æ—¢å­˜ã®player.jsã‚’èª­ã¿è¾¼ã¿ -->
<script src="{{ url_for('static', filename='js/player.js') }}"></script>
{% endblock %}